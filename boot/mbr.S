<<<<<<< HEAD
%include "include/boot.inc"
;å®žæ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼ä¸­
;éœ€è¦æ‰“å¼€20ä½åœ°å€çº¿  åŸºå€ï¼š0xffff*16=0xffff0    åç§»åœ°å€0xffff
;è¿™ç§åŸºå€åœ°å€+åç§»åœ°å€è¡¨ç¤ºçš„æœ€å¤§åœ°å€ 0xffff0+0xffff=0xfffff+0xfff0
;20ä½åœ°å€çº¿æœ€å¤§åœ°å€ 0xfffff  
;å¤šå‡ºçš„0xfff0çš„åœ°å€ç©ºé—´æ˜¯æ— æ³•è¾¾åˆ°çš„
;æ‰€ä»¥éœ€è¦æ‰“å¼€20ä½åœ°å€çº¿ å–æ¨¡å›žé€€  è¶…å‡ºéƒ¨åˆ†ä»Ž0å¼€å§‹
section MBR vstart=0x7c00
        mov ax,cs
        mov ds,ax
        mov es,ax
        mov ss,ax
        mov fs,ax
        mov sp,0x7c00
        mov ax,0xb800
        mov gs,ax
; æ¸…å± åˆ©ç”¨0x06å·åŠŸèƒ½ï¼Œä¸Šå·å…¨éƒ¨è¡Œï¼Œåˆ™å¯æ¸…å±ã€‚
; -----------------------------------------------------------
;INT 0x10   åŠŸèƒ½å·:0x06	   åŠŸèƒ½æè¿°:ä¸Šå·çª—å£
;------------------------------------------------------
;è¾“å…¥ï¼š
;AH åŠŸèƒ½å·= 0x06
;AL = ä¸Šå·çš„è¡Œæ•°(å¦‚æžœä¸º0,è¡¨ç¤ºå…¨éƒ¨)
;BH = ä¸Šå·è¡Œå±žæ€§
;(CL,CH) = çª—å£å·¦ä¸Šè§’çš„(X,Y)ä½ç½®
;(DL,DH) = çª—å£å³ä¸‹è§’çš„(X,Y)ä½ç½®
;æ— è¿”å›žå€¼ï¼š
        mov ax,0x0600
        mov bx,0x0700
        mov cx,0
        mov dx,0x184f
        int 0x10

        ;èŽ·å–å…‰æ ‡
        mov ah,3   ;è¾“å‡ºå…‰æ ‡ä½ç½® dxä¸­ æ‰“å°å­—ç¬¦ä¸­éœ€è¦
        mov bh,0
        int 0x10

        ;æ‰“å°å­—ç¬¦ä¸²
        mov ax,message
        mov bp,ax

        mov cx,0xf  ;ä¸²çš„é•¿åº¦
        mov ax,0x1301
        mov bx,0x2
        int 0x10
        
        
        mov bx,shine
        mov bp,0x00
        mov cx,0x5
color: 
        mov al,[bx]    
        mov byte [gs:bp], al
        inc bx
        inc bp
        mov byte [gs:bp], 0xA4 ; A è¡¨ç¤ºç»¿è‰²èƒŒæ™¯é—ªçƒï¼Œ 4 è¡¨ç¤ºå‰æ™¯è‰²ä¸ºçº¢è‰²
        inc bp
        loop color

        ;è¯»å–ç¡¬ç›˜åˆ°å†…å­˜
        mov eax,LOADER_START_SECTOR;åŠ è½½çš„èµ·å§‹æ‰‡åŒº
        mov bx,LOADER_BASE_ADDR ;åŠ è½½çš„å†…å­˜åœ°å€
        mov cx,1 ;å†™å…¥çš„æ‰‡åŒºæ•°
        call rd_disk_m_16 ;è¯»å–ç¡¬ç›˜
        jmp LOADER_BASE_ADDR ;è·³è½¬
        
rd_disk_m_16:
        mov esi,eax
        mov di,cx

        mov dx,0x1f2;è¯»å–æ‰‡åŒºæ•°
        mov al,cl
        out dx,al
        
        ;eaxè¢«ç ´çŽ¯  mov al,cl
        mov eax,esi;æ¢å¤
        ;è®¾ç½®lbaåœ°å€0x1f3-0x1f6 28ä½
        mov dx,0x1f3
        out dx,al
        
        mov cl,8 ;å³ç§»8ä½
        shr eax,cl
        mov dx,0x1f4
        out dx,al

        shr eax,cl ;å³ç§»8ä½
        mov dx,0x1f5
        out dx,al

        shr eax,cl ;å³ç§»8ä½
        and al,0x0f
        or al,0xe0 ;1110 
        mov dx,0x1f6
        out dx,al
        
       ;ç¬¬3æ­¥ï¼šå‘0x1f7ç«¯å£å†™å…¥è¯»å‘½ä»¤ï¼Œ0x20 
       mov dx,0x1f7
       mov al,0x20                        
       out dx,al

;ç¬¬4æ­¥ï¼šæ£€æµ‹ç¡¬ç›˜çŠ¶æ€
  .not_ready:
      ;åŒä¸€ç«¯å£ï¼Œå†™æ—¶è¡¨ç¤ºå†™å…¥å‘½ä»¤å­—ï¼Œè¯»æ—¶è¡¨ç¤ºè¯»å…¥ç¡¬ç›˜çŠ¶æ€
      nop
      in al,dx
      and al,0x88	   ;ç¬¬4ä½ä¸º1è¡¨ç¤ºç¡¬ç›˜æŽ§åˆ¶å™¨å·²å‡†å¤‡å¥½æ•°æ®ä¼ è¾“ï¼Œç¬¬7ä½ä¸º1è¡¨ç¤ºç¡¬ç›˜å¿™
      cmp al,0x08
      jnz .not_ready	   ;è‹¥æœªå‡†å¤‡å¥½ï¼Œç»§ç»­ç­‰ã€‚
      
    
      mov ax,di   ;ä¸€å…±512ä¸ªæ‰‡åŒºæ•°  ä¸€æ¬¡è¯»ä¸€ä¸ªå­—   256
      mov dx,256
      mul dx
      mov cx,ax
      mov dx,0x1f0
 .copy_read_byte:
      in ax,dx
      mov [bx],ax
      add bx,2
      loop .copy_read_byte         


      ret ;è¿”å›ž
       
message db 'Welcome to MBR!'
shine db 'color'
times 510-($-$$) db 0  
;$ä»£è¡¨æœ¬è¡Œåœ°å€   $$ä»£è¡¨æ®µå¼€å§‹åœ°å€  $-$$=åç§»é‡   bootæ€»çš„å­—èŠ‚æ•°512
;ä¸‹é¢å 2ä¸ªå­—èŠ‚   æ•…è¿™æ®µå­—èŠ‚èµ‹å€¼0 510-($-$$)
db 0x55,0xaa

; ç¡¬ç›˜åŸºç¡€     ä¸€å—ä¸»æ¿ä¸Šæœ‰ä¸¤ä¸ªæ’æ§½   æ’æ§½ä¸€ ç¬¬ä¸€é€šé“  å¯ä»¥æŒ‚ä¸¤å—ç¡¬ç›˜ ä¸» æ¬¡  æ’æ§½äºŒ ç¬¬äºŒé€šé“  å¯ä»¥æŒ‚ä¸¤å—ç¡¬ç›˜ ä¸» æ¬¡  
;                                                    è¯»                                         å†™
;                         IOç«¯å£                   ç«¯å£çš„ä½œç”¨                                 ç«¯å£çš„ä½œç”¨
; ç¬¬ä¸€é€šé“                 0x1F0                    è¯»å–æ•°æ®                                   è¯»å–æ•°æ®
;                         0x1F1                    è¯»å–å¤±è´¥çŠ¶æ€ä¿¡æ¯                            å†™å‘½ä»¤å‚æ•°
;                         0x1F2                    æœªè¯»å–çš„æ‰‡åŒºæ•°                              å¾…å†™å…¥æ‰‡åŒºæ•°
;                         0x1F3                    LBA 0-7ä½                                   LBA 0-7ä½
;                         0x1F4                    8-15                                        8-15
;                         0x1F5                    16-23                                        16-23
;                         0x1F6                    device å¯„å­˜å™¨ 0-3ä½  å‚¨æ”¾LBAçš„24-27ä½       åŒè¯»æ“ä½œ
;                                                  ç¬¬4ä½ ä»£è¡¨ä¸»ç›˜ ä»Žç›˜   
;                                                  ç¬¬6ä½ä»£è¡¨LBAæ¨¡å¼ 0ï¼šCHS 1:LBA å‰©ä¸‹ä½éƒ½æ˜¯1 
;                         0x1F7                    å®ƒæ˜¯ 8 ä½å®½åº¦çš„å¯„å­˜å™¨ï¼Œç”¨æ¥ç»™å‡ºç¡¬ç›˜çš„çŠ¶æ€ä¿¡æ¯ã€‚|  å†™å‘½ä»¤()
; ç¬¬ 0 ä½æ˜¯ ERR ä½ï¼Œå¦‚æžœæ­¤ä½ä¸º 1 ï¼Œè¡¨ç¤ºå‘½ä»¤å‡ºé”™äº†ï¼Œå…·ä½“åŽŸå› å¯è§ error å¯„å­˜å™¨ã€‚
; ç¬¬ 3 ä½æ˜¯request ä½ï¼Œå¦‚æžœæ­¤ä½ä¸º 1 ï¼Œè¡¨ç¤ºç¡¬ç›˜å·±ç»æŠŠæ•°æ®å‡†å¤‡å¥½äº†ï¼Œä¸»æœºçŽ°åœ¨å¯ä»¥æŠŠæ•°æ®è¯»å‡ºæ¥ã€‚
; ç¬¬ 6 ä½æ˜¯ DRDY,è¡¨ç¤ºç¡¬ç›˜å°±ç»ªï¼Œæ­¤ä½æ˜¯åœ¨å¯¹ç¡¬ç›˜è¯Šæ–­æ—¶ç”¨çš„ï¼Œè¡¨ç¤ºç¡¬ç›˜æ£€æµ‹æ­£å¸¸ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä¸€äº›å‘½ä»¤ ã€‚\
; ç¬¬ 7 ä½æ˜¯ BSYä½ï¼Œè¡¨ç¤ºç¡¬ç›˜æ˜¯å¦ç¹å¿™ï¼Œå¦‚æžœä¸º 1 è¡¨ç¤ºç¡¬ç›˜æ­£å¿™ç€ï¼Œæ­¤å¯„å­˜å™¨ä¸­çš„å…¶ä»–ä½éƒ½æ— æ•ˆã€‚
;
;
;
;ç¬¬äºŒé€šé“               0x170
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
=======
;Ö÷Òýµ¼³ÌÐò 
;------------------------------------------------------------
%include "boot.inc"
SECTION MBR vstart=0x7c00         
   mov ax,cs      
   mov ds,ax
   mov es,ax
   mov ss,ax
   mov fs,ax
   mov sp,0x7c00
   mov ax,0xb800
   mov gs,ax

; ÇåÆÁ
;ÀûÓÃ0x06ºÅ¹¦ÄÜ£¬ÉÏ¾íÈ«²¿ÐÐ£¬Ôò¿ÉÇåÆÁ¡£
; -----------------------------------------------------------
;INT 0x10   ¹¦ÄÜºÅ:0x06	   ¹¦ÄÜÃèÊö:ÉÏ¾í´°¿Ú
;------------------------------------------------------
;ÊäÈë£º
;AH ¹¦ÄÜºÅ= 0x06
;AL = ÉÏ¾íµÄÐÐÊý(Èç¹ûÎª0,±íÊ¾È«²¿)
;BH = ÉÏ¾íÐÐÊôÐÔ
;(CL,CH) = ´°¿Ú×óÉÏ½ÇµÄ(X,Y)Î»ÖÃ
;(DL,DH) = ´°¿ÚÓÒÏÂ½ÇµÄ(X,Y)Î»ÖÃ
;ÎÞ·µ»ØÖµ£º
   mov     ax, 0600h
   mov     bx, 0700h
   mov     cx, 0                   ; ×óÉÏ½Ç: (0, 0)
   mov     dx, 184fh		   ; ÓÒÏÂ½Ç: (80,25),
				   ; ÒòÎªVGAÎÄ±¾Ä£Ê½ÖÐ£¬Ò»ÐÐÖ»ÄÜÈÝÄÉ80¸ö×Ö·û,¹²25ÐÐ¡£
				   ; ÏÂ±ê´Ó0¿ªÊ¼£¬ËùÒÔ0x18=24,0x4f=79
   int     10h                     ; int 10h

   ; Êä³ö×Ö·û´®:MBR
   mov byte [gs:0x00],'1'
   mov byte [gs:0x01],0xA4

   mov byte [gs:0x02],' '
   mov byte [gs:0x03],0xA4

   mov byte [gs:0x04],'M'
   mov byte [gs:0x05],0xA4	   ;A±íÊ¾ÂÌÉ«±³¾°ÉÁË¸£¬4±íÊ¾Ç°¾°É«ÎªºìÉ«

   mov byte [gs:0x06],'B'
   mov byte [gs:0x07],0xA4

   mov byte [gs:0x08],'R'
   mov byte [gs:0x09],0xA4
	 
   mov eax,LOADER_START_SECTOR	 ; ÆðÊ¼ÉÈÇølbaµØÖ·
   mov bx,LOADER_BASE_ADDR       ; Ð´ÈëµÄµØÖ·
   mov cx,4			 ; ´ý¶ÁÈëµÄÉÈÇøÊý
   call rd_disk_m_16		 ; ÒÔÏÂ¶ÁÈ¡³ÌÐòµÄÆðÊ¼²¿·Ö£¨Ò»¸öÉÈÇø£©
  
   jmp LOADER_BASE_ADDR + 0x300
       
;-------------------------------------------------------------------------------
;¹¦ÄÜ:¶ÁÈ¡Ó²ÅÌn¸öÉÈÇø
rd_disk_m_16:	   
;-------------------------------------------------------------------------------
				       ; eax=LBAÉÈÇøºÅ
				       ; ebx=½«Êý¾ÝÐ´ÈëµÄÄÚ´æµØÖ·
				       ; ecx=¶ÁÈëµÄÉÈÇøÊý
      mov esi,eax	  ;±¸·Ýeax
      mov di,cx		  ;±¸·Ýcx
;¶ÁÐ´Ó²ÅÌ:
;µÚ1²½£ºÉèÖÃÒª¶ÁÈ¡µÄÉÈÇøÊý
      mov dx,0x1f2
      mov al,cl
      out dx,al            ;¶ÁÈ¡µÄÉÈÇøÊý

      mov eax,esi	   ;»Ö¸´ax

;µÚ2²½£º½«LBAµØÖ·´æÈë0x1f3 ~ 0x1f6

      ;LBAµØÖ·7~0Î»Ð´Èë¶Ë¿Ú0x1f3
      mov dx,0x1f3                       
      out dx,al                          

      ;LBAµØÖ·15~8Î»Ð´Èë¶Ë¿Ú0x1f4
      mov cl,8
      shr eax,cl
      mov dx,0x1f4
      out dx,al

      ;LBAµØÖ·23~16Î»Ð´Èë¶Ë¿Ú0x1f5
      shr eax,cl
      mov dx,0x1f5
      out dx,al

      shr eax,cl
      and al,0x0f	   ;lbaµÚ24~27Î»
      or al,0xe0	   ; ÉèÖÃ7¡«4Î»Îª1110,±íÊ¾lbaÄ£Ê½
      mov dx,0x1f6
      out dx,al

;µÚ3²½£ºÏò0x1f7¶Ë¿ÚÐ´Èë¶ÁÃüÁî£¬0x20 
      mov dx,0x1f7
      mov al,0x20                        
      out dx,al

;µÚ4²½£º¼ì²âÓ²ÅÌ×´Ì¬
  .not_ready:
      ;Í¬Ò»¶Ë¿Ú£¬Ð´Ê±±íÊ¾Ð´ÈëÃüÁî×Ö£¬¶ÁÊ±±íÊ¾¶ÁÈëÓ²ÅÌ×´Ì¬
      nop
      in al,dx
      and al,0x88	   ;µÚ4Î»Îª1±íÊ¾Ó²ÅÌ¿ØÖÆÆ÷ÒÑ×¼±¸ºÃÊý¾Ý´«Êä£¬µÚ7Î»Îª1±íÊ¾Ó²ÅÌÃ¦
      cmp al,0x08
      jnz .not_ready	   ;ÈôÎ´×¼±¸ºÃ£¬¼ÌÐøµÈ¡£

;µÚ5²½£º´Ó0x1f0¶Ë¿Ú¶ÁÊý¾Ý
      mov ax, di
      mov dx, 256
      mul dx
      mov cx, ax	   ; diÎªÒª¶ÁÈ¡µÄÉÈÇøÊý£¬Ò»¸öÉÈÇøÓÐ512×Ö½Ú£¬Ã¿´Î¶ÁÈëÒ»¸ö×Ö£¬
			   ; ¹²Ðèdi*512/2´Î£¬ËùÒÔdi*256
      mov dx, 0x1f0
  .go_on_read:
      in ax,dx
      mov [bx],ax
      add bx,2		  
      loop .go_on_read
      ret

   times 510-($-$$) db 0
   db 0x55,0xaa
>>>>>>> fc53d089f66f7d692fa32892b97ffe172b127c7f
